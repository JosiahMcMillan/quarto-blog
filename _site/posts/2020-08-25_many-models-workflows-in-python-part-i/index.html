<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.257">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Hayes">
<meta name="dcterms.date" content="2020-08-25">

<title>alex hayes - many models workflows in python: part i</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="alex hayes - many models workflows in python: part i">
<meta property="og:site-name" content="alex hayes">
<meta name="twitter:title" content="alex hayes - many models workflows in python: part i">
<meta name="twitter:creator" content="@alexpghayes">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">alex hayes</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">about</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html">posts</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../papers/index.html">papers</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code/index.html">code</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching/index.html">teaching</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks/index.html">talks</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/alexpghayes"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexpghayes"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">many models workflows in python: part i</h1>
            <p class="subtitle lead"></p><p>python modeling with list columns</p><p></p>
                </div>
  </div>
    
  



  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Alex Hayes <a href="https://orcid.org/0000-0002-4985-5160" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">2020-08-25</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#interlude-for-pythonistas-many-models-workflows" id="toc-interlude-for-pythonistas-many-models-workflows" class="nav-link active" data-scroll-target="#interlude-for-pythonistas-many-models-workflows">Interlude for Pythonistas: many models workflows</a></li>
  <li><a href="#why-is-putting-model-objects-in-dataframes-a-good-idea" id="toc-why-is-putting-model-objects-in-dataframes-a-good-idea" class="nav-link" data-scroll-target="#why-is-putting-model-objects-in-dataframes-a-good-idea">Why is putting model objects in dataframes a good idea?</a></li>
  <li><a href="#setting-the-scene" id="toc-setting-the-scene" class="nav-link" data-scroll-target="#setting-the-scene">Setting the scene</a></li>
  <li><a href="#step-1-specifying-models-to-fit" id="toc-step-1-specifying-models-to-fit" class="nav-link" data-scroll-target="#step-1-specifying-models-to-fit">Step 1: specifying models to fit</a></li>
  <li><a href="#step-2-iterative-model-fitting" id="toc-step-2-iterative-model-fitting" class="nav-link" data-scroll-target="#step-2-iterative-model-fitting">Step 2: iterative model fitting</a></li>
  <li><a href="#step-3-iterative-information-extraction" id="toc-step-3-iterative-information-extraction" class="nav-link" data-scroll-target="#step-3-iterative-information-extraction">Step 3: iterative information extraction</a></li>
  <li><a href="#flattening-the-dataframe" id="toc-flattening-the-dataframe" class="nav-link" data-scroll-target="#flattening-the-dataframe">Flattening the dataframe</a></li>
  <li><a href="#the-end" id="toc-the-end" class="nav-link" data-scroll-target="#the-end">The end</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/alexpghayes/quarto-blog/edit/main/posts/2020-08-25_many-models-workflows-in-python-part-i/index.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/alexpghayes/quarto-blog/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This summer I worked on my first substantial research project in Python. I’ve used Python for a number of small projects before, but this was the first time that it was important for me to have an efficient workflow for working with many models at once. In R, I spend almost all of my time using a ‘many models’ workflow that leverages list-columns in <code>tibble</code>s and a hefty amount of <code>tidyverse</code> manipulation. It’s taken me a while to find a similar workflow in Python that I like, and so I’m documenting it here for myself and other parties who might benefit.</p>
<p>This post demonstrates how to organize models into dataframes for exploratory data analysis, and discusses why you might want to do this. In a future blog post I will show how to extend the basic workflow I present here to handle sample splitting, custom estimators, and parallel processing.</p>
<section id="interlude-for-pythonistas-many-models-workflows" class="level2">
<h2 class="anchored" data-anchor-id="interlude-for-pythonistas-many-models-workflows">Interlude for Pythonistas: many models workflows</h2>
<p>The many models workflow is an extension of the ‘split-apply-combine’ workflow, a largely functional approach to data manipulation implemented in <code>dplyr</code> and <code>pandas</code>. The essential ideas of ‘split-apply-combine’ are articulated nicely in Hadley Wickham’s short and easy to read <a href="https://www.jstatsoft.org/article/view/v040i01/v40i01.pdf">paper</a>, which I strongly encourage you to read. I assume you are comfortable with this general idea, which largely facilitates natural ways to compute descriptive statistics from data, and have some experience applying these concepts in either <code>dplyr</code>, <code>pandas</code>, or SQL.</p>
<p>Several years ago, this idea evolved: what if, instead of computing descriptive statistics, we wanted to compute more complicated estimands, while leveraging the power of grouped operations? Hadley’s solution, which has proven very fruitful and served as the underlying idea for <code>tidymodels</code>, <code>tidyverts</code>, and several other modeling frameworks, is to put model objects themselves into dataframes. Hadley <a href="https://www.youtube.com/watch?v=rz3_FDVt9eg">presented</a> on this idea, and also wrote about it in the <a href="https://r4ds.had.co.nz/many-models.html">many models chapter</a> of <em>R for Data Science</em> and it has turned out to be quite fruitful.</p>
</section>
<section id="why-is-putting-model-objects-in-dataframes-a-good-idea" class="level2">
<h2 class="anchored" data-anchor-id="why-is-putting-model-objects-in-dataframes-a-good-idea">Why is putting model objects in dataframes a good idea?</h2>
<p>The simple answer is that it keeps information about your models from drifting apart, as it tends to do otherwise.</p>
<p>My exploratory modeling often ends up looking something like this:</p>
<ul>
<li><p>I want to compare models across a range of hyperparameter values. Often there are several distinct hyperparameters to consider at once<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p></li>
<li><p>I want to look at many different properties of the model. As a contrived example, I might want to look at AIC, BIC, <span class="math inline">\(R^2\)</span> and RMSE for all my models<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p></li>
<li><p>I want to quick create plots to compare these models, and am probably using a plotting libraries expects data in data frames</p></li>
</ul>
<p>Anyway it turns out that dataframes handle this use case super well, provided we have some helpers. The overall workflow will look like this:</p>
<ol type="1">
<li><p><strong>Specifying models to fit</strong>: We organize a dataframe so that each row of the dataframe corresponds to one model we want to fit. For example, a single row of the dataframe might correspond to a single set of hyperparameter values, or a subset of the data.</p></li>
<li><p><strong>Iterative model fitting</strong>: We create a new column in the dataframes that holds fit models.</p></li>
<li><p><strong>Iterative estimate extraction</strong>: We extract information we want from the fits into new data frame columns, and then manipulate this data with our favorite dataframe or plotting libraries.</p></li>
</ol>
<p>Note that steps (2) and (3) require iteration over many models. In functional languages, <code>map</code>-style operations are a natural (and easily parallelizable!) way to do this; in Python we can use list-comprehensions.</p>
<p>Another innovation in this workflow came from standardizing step (3), where we extract information from the models into a new column of the dataframe. A big issue that we can run into here is that when we extract information from the model object, it can have an inconvenient type that is hard to put in a dataframe column. This may seem esoteric but it turns out to matter a lot more than you’d expect.</p>
<p>David Robinson in his <code>broom</code> package proposed a solution that is increasingly the standard within the R community<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. The idea is to create special getter methods for model objects that always return information in consistently formatted data frames. For each model object, we get a data frame with information. Since there are many model objects, we end up with a column of dataframes, which we then flatten.</p>
<p>There has been a lot of pushback around the idea of a column of dataframes with the Python community, largely on the basis that it is not a performant data structure<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. This misses the point. The compute time in these workflows comes from model fitting, and afterwards we just want to keep track of things<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<p>Anyway, there’s a lot more to say about the workflow conceptually, but for now, it is time to show some code and see how things work in practice. For this post, I am going to recreate the analysis that Hadley does in his linked presentation above, which makes use of the <a href="https://pypi.org/project/gapminder/">gapminder</a> data. The gapminder data consists of life expectancies for 142 counties, reported every 5 years from 1952 to 2007.</p>
</section>
<section id="setting-the-scene" class="level2">
<h2 class="anchored" data-anchor-id="setting-the-scene">Setting the scene</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># you can download the gapminder csv file from my google drive</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># https://drive.google.com/file/d/1pAgIKdsZPwYteQ2rfq14WrUtS23Tg4Lu/</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>gapminder <span class="op">=</span> pd.read_csv(<span class="st">'gapminder.csv'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>gapminder</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>country</th>
      <th>continent</th>
      <th>year</th>
      <th>lifeExp</th>
      <th>pop</th>
      <th>gdpPercap</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1952</td>
      <td>28.801</td>
      <td>8425333</td>
      <td>779.445314</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1957</td>
      <td>30.332</td>
      <td>9240934</td>
      <td>820.853030</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1962</td>
      <td>31.997</td>
      <td>10267083</td>
      <td>853.100710</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1967</td>
      <td>34.020</td>
      <td>11537966</td>
      <td>836.197138</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1972</td>
      <td>36.088</td>
      <td>13079460</td>
      <td>739.981106</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1699</th>
      <td>Zimbabwe</td>
      <td>Africa</td>
      <td>1987</td>
      <td>62.351</td>
      <td>9216418</td>
      <td>706.157306</td>
    </tr>
    <tr>
      <th>1700</th>
      <td>Zimbabwe</td>
      <td>Africa</td>
      <td>1992</td>
      <td>60.377</td>
      <td>10704340</td>
      <td>693.420786</td>
    </tr>
    <tr>
      <th>1701</th>
      <td>Zimbabwe</td>
      <td>Africa</td>
      <td>1997</td>
      <td>46.809</td>
      <td>11404948</td>
      <td>792.449960</td>
    </tr>
    <tr>
      <th>1702</th>
      <td>Zimbabwe</td>
      <td>Africa</td>
      <td>2002</td>
      <td>39.989</td>
      <td>11926563</td>
      <td>672.038623</td>
    </tr>
    <tr>
      <th>1703</th>
      <td>Zimbabwe</td>
      <td>Africa</td>
      <td>2007</td>
      <td>43.487</td>
      <td>12311143</td>
      <td>469.709298</td>
    </tr>
  </tbody>
</table>
<p>1704 rows × 6 columns</p>
</div>
</div>
</div>
<p>To get a feel for the data, lets plot the life expectancy of each country over time, facetting by continent<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> sns.FacetGrid(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>gapminder,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">'continent'</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    col<span class="op">=</span><span class="st">'continent'</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    col_wrap<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    aspect<span class="op">=</span><span class="dv">16</span><span class="op">/</span><span class="dv">9</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>).<span class="bu">map</span>(plt.plot, <span class="st">'year'</span>, <span class="st">'lifeExp'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-3-output-1.png" width="1355" height="1139"></p>
</div>
</div>
</section>
<section id="step-1-specifying-models-to-fit" class="level2">
<h2 class="anchored" data-anchor-id="step-1-specifying-models-to-fit">Step 1: specifying models to fit</h2>
<p>Following Hadley’s presentation, suppose we would like to summarize the trend for each country by fitting a linear regression to the data from each country. So we have a correspondence 1 model ~ data from 1 country, and want to set up our data frame so that each row corresponds to data from a single country.</p>
<p><code>groupby()</code> plus a list-comprehension handles this nicely, leveraging the fact that <code>gapminder.groupby('country')</code> is an iterable. In R, you could also use <code>group_by()</code> for this step, or additionally <code>nest()</code> or <code>rowwise()</code>, two <code>tidyverse</code> specification abstractions.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> pd.DataFrame({</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this works because grouped dataframes in pandas are iterable</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and because you can pretty much treat series objects like</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># they are lists</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data'</span>: [data <span class="cf">for</span> _, data <span class="kw">in</span> gapminder.groupby(<span class="st">'country'</span>)],</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>models.index <span class="op">=</span> [country <span class="cf">for</span> country, _ <span class="kw">in</span> gapminder.groupby(<span class="st">'country'</span>)]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># the downside of putting weird stuff into pandas dataframes is that</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># the dataframes print poorly</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>models</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Afghanistan</th>
      <td>country continent  year  lifeExp      ...</td>
    </tr>
    <tr>
      <th>Albania</th>
      <td>country continent  year  lifeExp      pop ...</td>
    </tr>
    <tr>
      <th>Algeria</th>
      <td>country continent  year  lifeExp       pop...</td>
    </tr>
    <tr>
      <th>Angola</th>
      <td>country continent  year  lifeExp       pop ...</td>
    </tr>
    <tr>
      <th>Argentina</th>
      <td>country continent  year  lifeExp       p...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Vietnam</th>
      <td>country continent  year  lifeExp       p...</td>
    </tr>
    <tr>
      <th>West Bank and Gaza</th>
      <td>country continent  year  life...</td>
    </tr>
    <tr>
      <th>Yemen, Rep.</th>
      <td>country continent  year  lifeExp    ...</td>
    </tr>
    <tr>
      <th>Zambia</th>
      <td>country continent  year  lifeExp       po...</td>
    </tr>
    <tr>
      <th>Zimbabwe</th>
      <td>country continent  year  lifeExp       ...</td>
    </tr>
  </tbody>
</table>
<p>142 rows × 1 columns</p>
</div>
</div>
</div>
</section>
<section id="step-2-iterative-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="step-2-iterative-model-fitting">Step 2: iterative model fitting</h2>
<p>Now we need to do the actual model fitting. My preferred approach is to use list-comprehensions.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> country_model(df):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> smf.ols(<span class="st">'lifeExp ~ year'</span>, data<span class="op">=</span>df).fit()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'fit'</span>] <span class="op">=</span> [</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    country_model(data)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, data <span class="kw">in</span> gapminder.groupby(<span class="st">'country'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One compelling advantage of this (effectively) functional approach to iteration over list-columns of models is that most of these computations are embarrassingly parallel, and map()-like operations are often very easy to parallelize.</p>
<p>An alternative approach here is to use <code>DataFrame.apply()</code>. However, I have found the <code>Series.apply()</code> and <code>DataFrame.apply()</code> methods to be hard to reason about when used together with list-columns, and so I recommend avoiding them.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the pandas apply() approach</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># models = (</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     gapminder</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     .groupby('country')</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     .apply(country_model)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     .to_frame(name='fit')</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-iterative-information-extraction" class="level2">
<h2 class="anchored" data-anchor-id="step-3-iterative-information-extraction">Step 3: iterative information extraction</h2>
<p>Now that we’ve fit all of our models, we can extract information from them. Here I’ll define some helper functions very much in the spirit of <code>broom</code>. When you don’t own the model classes you’re using, you pretty much have to write extractor functions to do this; see Michael Chow’s excellent <a href="https://mchow.com/posts/2020-02-24-single-dispatch-data-science/">blog post</a> showing how to handle this in an elegant way.</p>
<p>Even if you do own the model objects you’re using, I recommend extractor functions over class methods. This is because, during EDA, you typically fit some expensive models once, and then repeatedly investigate them–you can modify an extractor function and use it right away, but if you modify a method for a model class, you’ll have to refit all the model objects. This leads to slow iteration.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ripped directly from michael chow's blog post!!</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># go read his stuff it's very cool!</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tidy(fit):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> statsmodels.iolib.summary <span class="im">import</span> summary_params_frame</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    tidied <span class="op">=</span> summary_params_frame(fit).reset_index()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    rename_cols <span class="op">=</span> {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'index'</span>: <span class="st">'term'</span>, <span class="st">'coef'</span>: <span class="st">'estimate'</span>, <span class="st">'std err'</span>: <span class="st">'std_err'</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t'</span>: <span class="st">'statistic'</span>, <span class="st">'P&gt;|t|'</span>: <span class="st">'p_value'</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Conf. Int. Low'</span>: <span class="st">'conf_int_low'</span>, <span class="st">'Conf. Int. Upp.'</span>: <span class="st">'conf_int_high'</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tidied.rename(columns <span class="op">=</span> rename_cols)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> glance(fit):</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aic'</span>: fit.aic,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bic'</span>: fit.bic,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ess'</span>: fit.ess, <span class="co"># explained sum of squares</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'centered_tss'</span>: fit.centered_tss,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fvalue'</span>: fit.fvalue,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'f_pvalue'</span>: fit.f_pvalue,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nobs'</span>: fit.nobs,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rsquared'</span>: fit.rsquared,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rsquared_adj'</span>: fit.rsquared_adj</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># note that augment() takes 2 inputs, whereas tidy() and glance() take 1</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment(fit, data):</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.copy()</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">!=</span> fit.nobs:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"`data` does not have same number of observations as in training data."</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'fitted'</span>] <span class="op">=</span> fit.fittedvalues</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'resid'</span>] <span class="op">=</span> fit.resid</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We sanity check the helper functions by seeing if they work on a single model object before working with the entire list-column of models.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tidy(models.fit[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>term</th>
      <th>estimate</th>
      <th>std_err</th>
      <th>statistic</th>
      <th>p_value</th>
      <th>conf_int_low</th>
      <th>conf_int_high</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Intercept</td>
      <td>-507.534272</td>
      <td>40.484162</td>
      <td>-12.536613</td>
      <td>1.934055e-07</td>
      <td>-597.738606</td>
      <td>-417.329937</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>0.275329</td>
      <td>0.020451</td>
      <td>13.462890</td>
      <td>9.835213e-08</td>
      <td>0.229761</td>
      <td>0.320896</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>glance(models.fit[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>aic</th>
      <th>bic</th>
      <th>ess</th>
      <th>centered_tss</th>
      <th>fvalue</th>
      <th>f_pvalue</th>
      <th>nobs</th>
      <th>rsquared</th>
      <th>rsquared_adj</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>40.69387</td>
      <td>41.663683</td>
      <td>271.006011</td>
      <td>285.958116</td>
      <td>181.24941</td>
      <td>9.835213e-08</td>
      <td>12.0</td>
      <td>0.947712</td>
      <td>0.942483</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><code>augment()</code> actually takes two inputs, where one input is the model object, and the other is the training data used to fit that model object.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>augment(models.fit[<span class="dv">0</span>], models.data[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>country</th>
      <th>continent</th>
      <th>year</th>
      <th>lifeExp</th>
      <th>pop</th>
      <th>gdpPercap</th>
      <th>fitted</th>
      <th>resid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1952</td>
      <td>28.801</td>
      <td>8425333</td>
      <td>779.445314</td>
      <td>29.907295</td>
      <td>-1.106295</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1957</td>
      <td>30.332</td>
      <td>9240934</td>
      <td>820.853030</td>
      <td>31.283938</td>
      <td>-0.951938</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1962</td>
      <td>31.997</td>
      <td>10267083</td>
      <td>853.100710</td>
      <td>32.660582</td>
      <td>-0.663582</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1967</td>
      <td>34.020</td>
      <td>11537966</td>
      <td>836.197138</td>
      <td>34.037225</td>
      <td>-0.017225</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1972</td>
      <td>36.088</td>
      <td>13079460</td>
      <td>739.981106</td>
      <td>35.413868</td>
      <td>0.674132</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1977</td>
      <td>38.438</td>
      <td>14880372</td>
      <td>786.113360</td>
      <td>36.790512</td>
      <td>1.647488</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1982</td>
      <td>39.854</td>
      <td>12881816</td>
      <td>978.011439</td>
      <td>38.167155</td>
      <td>1.686845</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1987</td>
      <td>40.822</td>
      <td>13867957</td>
      <td>852.395945</td>
      <td>39.543798</td>
      <td>1.278202</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1992</td>
      <td>41.674</td>
      <td>16317921</td>
      <td>649.341395</td>
      <td>40.920442</td>
      <td>0.753558</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>1997</td>
      <td>41.763</td>
      <td>22227415</td>
      <td>635.341351</td>
      <td>42.297085</td>
      <td>-0.534085</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>2002</td>
      <td>42.129</td>
      <td>25268405</td>
      <td>726.734055</td>
      <td>43.673728</td>
      <td>-1.544728</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Afghanistan</td>
      <td>Asia</td>
      <td>2007</td>
      <td>43.828</td>
      <td>31889923</td>
      <td>974.580338</td>
      <td>45.050372</td>
      <td>-1.222372</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Now we are ready to iterate over the list-column of models. Again, we leverage list-comprehensions. For <code>tidy()</code> and <code>glance()</code> these comprehension are straightforward, but for <code>augment()</code>, which will consume elements from two columns at once, we will need to do something a little fancier. In R we could use <code>purrr::map2()</code> or <code>purrr::pmap()</code>, but the Pythonic idiom here is to use <code>zip()</code> together with tuple unpacking.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'tidied'</span>] <span class="op">=</span> [tidy(fit) <span class="cf">for</span> fit <span class="kw">in</span> models.fit]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'glanced'</span>] <span class="op">=</span> [glance(fit) <span class="cf">for</span> fit <span class="kw">in</span> models.fit]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'augmented'</span>] <span class="op">=</span> [</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    augment(fit, data)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fit, data <span class="kw">in</span> <span class="bu">zip</span>(models.fit, models.data)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note for R users</strong>: In R the calls to <code>tidy()</code>, etc, would typically live inside a <code>mutate()</code> call. The <code>pandas</code> equivalent is <code>assign</code>, but <code>pandas</code> doesn’t leverage non-standard evaluation and I typically don’t use <code>assign()</code> unless I really want to leverage method chaining for some reason. Normally I save method chaining for data manipulation once I have a flat dataframe, and otherwise I operate entirely via list comprehensions.</p>
<p>Anyway, the print method garbles the hell out of our results but whatever.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>models</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data</th>
      <th>fit</th>
      <th>tidied</th>
      <th>glanced</th>
      <th>augmented</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Afghanistan</th>
      <td>country continent  year  lifeExp      ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>aic        bic         ess  centered_t...</td>
      <td>country continent  year  lifeExp      ...</td>
    </tr>
    <tr>
      <th>Albania</th>
      <td>country continent  year  lifeExp      pop ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>aic        bic         ess  centered_...</td>
      <td>country continent  year  lifeExp      pop ...</td>
    </tr>
    <tr>
      <th>Algeria</th>
      <td>country continent  year  lifeExp       pop...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>aic       bic          ess  centered_...</td>
      <td>country continent  year  lifeExp       pop...</td>
    </tr>
    <tr>
      <th>Angola</th>
      <td>country continent  year  lifeExp       pop ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>aic       bic         ess  centered_t...</td>
      <td>country continent  year  lifeExp       pop ...</td>
    </tr>
    <tr>
      <th>Argentina</th>
      <td>country continent  year  lifeExp       p...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate   std_err  statistic ...</td>
      <td>aic       bic         ess  centered_ts...</td>
      <td>country continent  year  lifeExp       p...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Vietnam</th>
      <td>country continent  year  lifeExp       p...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term     estimate    std_err  statisti...</td>
      <td>aic        bic          ess  centered...</td>
      <td>country continent  year  lifeExp       p...</td>
    </tr>
    <tr>
      <th>West Bank and Gaza</th>
      <td>country continent  year  life...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term     estimate    std_err  statisti...</td>
      <td>aic       bic          ess  centered_...</td>
      <td>country continent  year  life...</td>
    </tr>
    <tr>
      <th>Yemen, Rep.</th>
      <td>country continent  year  lifeExp    ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term     estimate    std_err  statisti...</td>
      <td>aic        bic          ess  centered...</td>
      <td>country continent  year  lifeExp    ...</td>
    </tr>
    <tr>
      <th>Zambia</th>
      <td>country continent  year  lifeExp       po...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate     std_err  statisti...</td>
      <td>aic        bic        ess  centered_t...</td>
      <td>country continent  year  lifeExp       po...</td>
    </tr>
    <tr>
      <th>Zimbabwe</th>
      <td>country continent  year  lifeExp       ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate     std_err  statisti...</td>
      <td>aic       bic        ess  centered_ts...</td>
      <td>country continent  year  lifeExp       ...</td>
    </tr>
  </tbody>
</table>
<p>142 rows × 5 columns</p>
</div>
</div>
</div>
</section>
<section id="flattening-the-dataframe" class="level2">
<h2 class="anchored" data-anchor-id="flattening-the-dataframe">Flattening the dataframe</h2>
<p>Our final step before we can recreate Hadley’s plots is to flatten or “unnest” the dataframe. <code>pandas</code> has no unnest method, but the following has served me well so far to unnest a single column. This will not play well with dataframes with MultiIndexes, which I recommend avoiding.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unnest(df, value_col):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    lst <span class="op">=</span> df[value_col].tolist()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    unnested <span class="op">=</span> pd.concat(lst, keys<span class="op">=</span>df.index)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    unnested.index <span class="op">=</span> unnested.index.droplevel(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.join(unnested).drop(columns<span class="op">=</span>value_col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we unnest just the <code>glance()</code> results we get:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>glance_results <span class="op">=</span> unnest(models, <span class="st">'glanced'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># equivalently</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>glance_results <span class="op">=</span> (</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    models</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    .pipe(unnest, <span class="st">'glanced'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># little bit of extra cleanup</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">'index'</span>: <span class="st">'country'</span>})</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>glance_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>country</th>
      <th>data</th>
      <th>fit</th>
      <th>tidied</th>
      <th>augmented</th>
      <th>aic</th>
      <th>bic</th>
      <th>ess</th>
      <th>centered_tss</th>
      <th>fvalue</th>
      <th>f_pvalue</th>
      <th>nobs</th>
      <th>rsquared</th>
      <th>rsquared_adj</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Afghanistan</td>
      <td>country continent  year  lifeExp      ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>country continent  year  lifeExp      ...</td>
      <td>40.693870</td>
      <td>41.663683</td>
      <td>271.006011</td>
      <td>285.958116</td>
      <td>181.249410</td>
      <td>9.835213e-08</td>
      <td>12.0</td>
      <td>0.947712</td>
      <td>0.942483</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Albania</td>
      <td>country continent  year  lifeExp      pop ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>country continent  year  lifeExp      pop ...</td>
      <td>52.298071</td>
      <td>53.267884</td>
      <td>400.445959</td>
      <td>439.771289</td>
      <td>101.829014</td>
      <td>1.462763e-06</td>
      <td>12.0</td>
      <td>0.910578</td>
      <td>0.901636</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Algeria</td>
      <td>country continent  year  lifeExp       pop...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>country continent  year  lifeExp       pop...</td>
      <td>42.584427</td>
      <td>43.554240</td>
      <td>1158.583855</td>
      <td>1176.087314</td>
      <td>661.917086</td>
      <td>1.808143e-10</td>
      <td>12.0</td>
      <td>0.985117</td>
      <td>0.983629</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Angola</td>
      <td>country continent  year  lifeExp       pop ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate    std_err  statistic...</td>
      <td>country continent  year  lifeExp       pop ...</td>
      <td>44.061857</td>
      <td>45.031670</td>
      <td>156.667858</td>
      <td>176.464605</td>
      <td>79.138182</td>
      <td>4.593498e-06</td>
      <td>12.0</td>
      <td>0.887815</td>
      <td>0.876596</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Argentina</td>
      <td>country continent  year  lifeExp       p...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate   std_err  statistic ...</td>
      <td>country continent  year  lifeExp       p...</td>
      <td>6.347866</td>
      <td>7.317679</td>
      <td>191.937384</td>
      <td>192.791819</td>
      <td>2246.366349</td>
      <td>4.215567e-13</td>
      <td>12.0</td>
      <td>0.995568</td>
      <td>0.995125</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>137</th>
      <td>Vietnam</td>
      <td>country continent  year  lifeExp       p...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term     estimate    std_err  statisti...</td>
      <td>country continent  year  lifeExp       p...</td>
      <td>42.414079</td>
      <td>43.383892</td>
      <td>1612.565329</td>
      <td>1629.822069</td>
      <td>934.455357</td>
      <td>3.289412e-11</td>
      <td>12.0</td>
      <td>0.989412</td>
      <td>0.988353</td>
    </tr>
    <tr>
      <th>138</th>
      <td>West Bank and Gaza</td>
      <td>country continent  year  life...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term     estimate    std_err  statisti...</td>
      <td>country continent  year  life...</td>
      <td>52.287427</td>
      <td>53.257240</td>
      <td>1291.726331</td>
      <td>1331.016795</td>
      <td>328.763323</td>
      <td>5.585089e-09</td>
      <td>12.0</td>
      <td>0.970481</td>
      <td>0.967529</td>
    </tr>
    <tr>
      <th>139</th>
      <td>Yemen, Rep.</td>
      <td>country continent  year  lifeExp    ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term     estimate    std_err  statisti...</td>
      <td>country continent  year  lifeExp    ...</td>
      <td>46.932773</td>
      <td>47.902586</td>
      <td>1310.527555</td>
      <td>1335.675109</td>
      <td>521.135193</td>
      <td>5.868274e-10</td>
      <td>12.0</td>
      <td>0.981172</td>
      <td>0.979290</td>
    </tr>
    <tr>
      <th>140</th>
      <td>Zambia</td>
      <td>country continent  year  lifeExp       po...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate     std_err  statisti...</td>
      <td>country continent  year  lifeExp       po...</td>
      <td>72.117172</td>
      <td>73.086985</td>
      <td>13.053046</td>
      <td>218.145441</td>
      <td>0.636447</td>
      <td>4.435318e-01</td>
      <td>12.0</td>
      <td>0.059836</td>
      <td>-0.034180</td>
    </tr>
    <tr>
      <th>141</th>
      <td>Zimbabwe</td>
      <td>country continent  year  lifeExp       ...</td>
      <td>&lt;statsmodels.regression.linear_model.Regressio...</td>
      <td>term    estimate     std_err  statisti...</td>
      <td>country continent  year  lifeExp       ...</td>
      <td>83.262706</td>
      <td>84.232520</td>
      <td>30.934127</td>
      <td>550.116442</td>
      <td>0.595824</td>
      <td>4.580290e-01</td>
      <td>12.0</td>
      <td>0.056232</td>
      <td>-0.038145</td>
    </tr>
  </tbody>
</table>
<p>142 rows × 14 columns</p>
</div>
</div>
</div>
<p>Now we could ask a question like “what countries seem to have the most linear trends in life expectancy?” and use R-squared as a measure of this.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    sns.FacetGrid(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>glance_results.sort_values(<span class="st">'rsquared'</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        aspect<span class="op">=</span><span class="dv">16</span><span class="op">/</span><span class="dv">9</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(plt.scatter, <span class="st">'rsquared'</span>, <span class="st">'country'</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-15-output-1.png" width="1354" height="756"></p>
</div>
</div>
<p>Okay so this plot is awful but I don’t have the patience at the moment to make it better. We could also look at residuals for individual fits to inspect them for any patterns that might indicate systematic error.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>augment_results <span class="op">=</span> unnest(models, <span class="st">'augmented'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    sns.FacetGrid(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>augment_results,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        col<span class="op">=</span><span class="st">'continent'</span>, </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        col_wrap<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        hue<span class="op">=</span><span class="st">'continent'</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">5</span>, aspect<span class="op">=</span><span class="dv">16</span><span class="op">/</span><span class="dv">9</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(plt.plot, <span class="st">'year'</span>, <span class="st">'resid'</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-16-output-1.png" width="1696" height="1427"></p>
</div>
</div>
<p>It would be nice to add smooths by continent as Hadley does but again I don’t have the patience or masochistic urge to figure out how to do that. In any case, there are some clear trends in the residuals, especially for Africa, which suggest that some further modeling is a good idea.</p>
</section>
<section id="the-end" class="level2">
<h2 class="anchored" data-anchor-id="the-end">The end</h2>
<p>So that’s the basic idea behind the many models workflow. Note that we’ve been working at a fairly low-level of abstraction. This means you have a lot of control over what happens (good for research and EDA), but have to write a lot of code. If you’re just fitting prediction models and the only thing you want to do is compare risk estimates, you can save time and effort by using <code>sklearn</code>’s <code>GridSearchCV</code> object.</p>
<p>One final note: in Hadley’s gapminder example we iterate over disjoint data sets. In practice I do this extremely rarely. Much more often I find myself iterating over <code>(train, test)</code> pairs, or hyperparameters, or both at once. This hyperparameter optimization over many CV-folds workflow is more complex than the simple example here, but still fits nicely into the many models workflow I’ve described here. I’ll demonstrate how to do that in a followup post.</p>


</section>


<div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>It often makes sense to store hyperparameters in dicts in Python. This means you can’t easily store model objects in dicts, because <code>model_store[hyperparameters] = my_model_object</code> gets all fussy because the hyperparameter dictionary isn’t hashable.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>One natural approach here would be to have a list of model objects, a list of AIC values, a list of BIC values, etc. Now you run into an indexing issue where you have to figure out which index corresponds to a given model and keeping track of a bunch of maps like this. A natural solution is to say force all the indexes to match up – everything with index 0 should correspond to the first model. Congratulations, you’ve just invented a data frame.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>I am currently the <code>broom</code> maintainer.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>Another big selling point of dataframes is vectorized operations on the columns. However, you can’t vectorize operations on model objects, and this leads to code that has to perform vectorize explicitly rather than letting dataframe libraries handle it implicitly. There is a definitely a learning curve for new users here but I’m pretty convinced it’s worth it.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>Another complaint that you might have as a Pythonista is that you should construct a custom model object to handle all this model tracking. I’m actually pretty curious about this and would love to hear ideas. My suspition is that the big challenge is coming up with a sufficiently general framework to accommodate widely varying use cases.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>Aside: I have found plotting in Python to be a largely unpleasant experience. At this point, I’ve pretty much settled on <code>seaborn</code> as my go-to plotting library, and I use <code>sns.FacetGrid</code> for almost everything, even when I don’t need facetting, because enough of my <code>ggplot2</code> intuition carries over that I can mostly get things done.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{hayes2020,
  author = {Alex Hayes},
  title = {Many Models Workflows in Python: Part i},
  date = {2020-08-25},
  url = {https://www.alexpghayes.com/posts/2020-08-25_many-models-workflows-in-python-part-i},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-hayes2020" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Alex Hayes. 2020. <span>“Many Models Workflows in Python: Part
i.”</span> August 25, 2020. <a href="https://www.alexpghayes.com/posts/2020-08-25_many-models-workflows-in-python-part-i">https://www.alexpghayes.com/posts/2020-08-25_many-models-workflows-in-python-part-i</a>.
</div></div></section></div></main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>