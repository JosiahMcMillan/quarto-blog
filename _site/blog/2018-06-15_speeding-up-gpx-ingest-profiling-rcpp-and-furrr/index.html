<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.257">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Hayes">
<meta name="dcterms.date" content="2018-06-15">

<title>alex hayes - speeding up GPX ingest: profiling, Rcpp and furrr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="alex hayes - speeding up GPX ingest: profiling, Rcpp and furrr">
<meta property="og:site-name" content="alex hayes">
<meta name="twitter:title" content="alex hayes - speeding up GPX ingest: profiling, Rcpp and furrr">
<meta name="twitter:creator" content="@alexpghayes">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">alex hayes</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">about</a>
  </li>  
  <li class="dropdown-header">
 posts.qmd</li>
  <li class="nav-item">
    <a class="nav-link" href="../../papers/index.html">papers</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code/index.html">code</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching/index.html">teaching</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks/index.html">talks</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/alexpghayes"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexpghayes"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">speeding up GPX ingest: profiling, Rcpp and furrr</h1>
            <p class="subtitle lead">profiling your way to happiness, or possibly bikeshedding</p>
                </div>
  </div>
    
  



  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Alex Hayes <a href="https://orcid.org/0000-0002-4985-5160" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">2018-06-15</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-problem-tidying-trajectories-in-gpx-files" id="toc-the-problem-tidying-trajectories-in-gpx-files" class="nav-link active" data-scroll-target="#the-problem-tidying-trajectories-in-gpx-files">The problem: tidying trajectories in GPX files</a></li>
  <li><a href="#gpx-reader-version-0-using-plotkmlreadgpx" id="toc-gpx-reader-version-0-using-plotkmlreadgpx" class="nav-link" data-scroll-target="#gpx-reader-version-0-using-plotkmlreadgpx">GPX reader version 0: using plotKML::readGPX</a></li>
  <li><a href="#gpx-reader-version-1-no-more-plotkmlgpx" id="toc-gpx-reader-version-1-no-more-plotkmlgpx" class="nav-link" data-scroll-target="#gpx-reader-version-1-no-more-plotkmlgpx">GPX reader version 1: no more plotKML::GPX</a></li>
  <li><a href="#gpx-reader-version-2-no-more-tibble" id="toc-gpx-reader-version-2-no-more-tibble" class="nav-link" data-scroll-target="#gpx-reader-version-2-no-more-tibble">GPX reader version 2: no more tibble</a>
  <ul class="collapse">
  <li><a href="#gpx-reader-version-3-now-with-more-xml2" id="toc-gpx-reader-version-3-now-with-more-xml2" class="nav-link" data-scroll-target="#gpx-reader-version-3-now-with-more-xml2">GPX reader version 3: now with more xml2</a></li>
  <li><a href="#gpx-reader-version-4-drop-into-rcpp" id="toc-gpx-reader-version-4-drop-into-rcpp" class="nav-link" data-scroll-target="#gpx-reader-version-4-drop-into-rcpp">GPX reader version 4: drop into Rcpp</a></li>
  <li><a href="#comparing-the-various-gpx-readers" id="toc-comparing-the-various-gpx-readers" class="nav-link" data-scroll-target="#comparing-the-various-gpx-readers">Comparing the various GPX readers</a></li>
  <li><a href="#embarrassing-parallelization-with-furrr" id="toc-embarrassing-parallelization-with-furrr" class="nav-link" data-scroll-target="#embarrassing-parallelization-with-furrr">Embarrassing parallelization with <code>furrr</code></a></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up">Wrap Up</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/alexpghayes/quarto-blog/edit/main/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr/index.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/alexpghayes/quarto-blog/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This post is a casual case study in speeding up R code. I work through several iterations of a function to read and process GPS running data from Strava stored in the GPX format. Along the way I describe how to visualize code bottlenecks with <code>profvis</code> and briefly touch on fast compiled code with <code>Rcpp</code> and parallelization with <code>furrr</code>.</p>
<section id="the-problem-tidying-trajectories-in-gpx-files" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-tidying-trajectories-in-gpx-files">The problem: tidying trajectories in GPX files</h2>
<p>I record my runs on my phone using Strava. Strava stores the GPS recordings in GPX files, which are XML files that follow some additional conventions. They start with some metadata and then contain a list of GPS readings taken at one second intervals with longitude, latitude, elevation and timestap information. I wanted to approximate my speed at each time point in the GPS record, as well as my distance traveled since the previous GPS recordings.</p>
<p>Below I have an example of a GPX file that contains three GPS readings. First I create a vector that contains the names off my GPX files, and then I subset to the files that contain running data. I choose to work with the third run as a canonical example, and show a subset of the recording with three GPS readings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────── tidyverse 1.3.1.9000 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ ggplot2 3.3.5.9000     ✔ purrr   0.3.4.9000
✔ tibble  3.1.7.9000     ✔ dplyr   1.0.8.9000
✔ tidyr   1.2.0.9000     ✔ stringr 1.4.0.9000
✔ readr   2.1.2.9000     ✔ forcats 0.5.1.9000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at /dabox/hayes/quarto-blog</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file contain run data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>act_files <span class="ot">&lt;-</span> <span class="fu">dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"posts/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr/2018-04-17-activities-alex"</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>run_files <span class="ot">&lt;-</span> act_files[<span class="fu">str_detect</span>(act_files, <span class="st">"Run"</span>)]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># example file we'll work with</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>fname <span class="ot">&lt;-</span> run_files[<span class="dv">3</span>]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># subset of example</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>all <span class="ot">&lt;-</span> <span class="fu">read_lines</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in if (length(res) == 0 || res == -1) {: missing value where TRUE/FALSE needed</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mini_idx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">5897</span><span class="sc">:</span><span class="dv">5899</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(all[mini_idx], <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in all[mini_idx]: object of type 'builtin' is not subsettable</code></pre>
</div>
</div>
<p>The part we want is in the <code>&lt;trkseg&gt;</code> tags. We’d like to turn this into a tidy dataframe where each row represents one GPS reading and the columns contain information like speed, distance, traveled, elevation gained, etc.</p>
</section>
<section id="gpx-reader-version-0-using-plotkmlreadgpx" class="level2">
<h2 class="anchored" data-anchor-id="gpx-reader-version-0-using-plotkmlreadgpx">GPX reader version 0: using plotKML::readGPX</h2>
<p>Using <code>plotKML::readGPX</code> we can read the representative file into R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>trajectory <span class="ot">&lt;-</span> gpx<span class="sc">::</span><span class="fu">read_gpx</span>(fname)<span class="sc">$</span>tracks <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>extensions, segment_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in gpx::read_gpx(fname): Specified file does not exist</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>trajectory</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'trajectory' not found</code></pre>
</div>
</div>
<p>We want to compare location at <span class="math inline">\(t\)</span> and <span class="math inline">\(t - 1\)</span>, so we create a lagged column of longitudes and latitudes. We put longitude and latitude together into a vector to play well with <code>raster::pointDistance</code>, which we’ll use to compute the great circle distance between two points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>lagged <span class="ot">&lt;-</span> trajectory <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">map2</span>(longitude, latitude, c),  <span class="co"># create lagged position, this means the </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">x_old =</span> <span class="fu">lag</span>(x),         <span class="co"># first row isn't complete</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">t_old =</span> <span class="fu">lag</span>(time)) <span class="sc">|&gt;</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>)                      <span class="co"># remove incomplete first row</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in mutate(trajectory, x = map2(longitude, latitude, c), x_old = lag(x), : object 'trajectory' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lagged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'lagged' not found</code></pre>
</div>
</div>
<p>It turns out this data is not contiguous. Strava has a feature called autopause which detects pauses in runs (for example, at a stoplight), and GPS readings during paused periods are not include in the GPX files<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. GPS readings typically happen once every second. I plotted the time gaps between readings and realized that time gaps greater than three seconds between two GPS recordings indicated a pause. This lets me break the run down into a series of contigous segments:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>segmented <span class="ot">&lt;-</span> lagged <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rest =</span> <span class="fu">as.numeric</span>(time <span class="sc">-</span> t_old),     <span class="co"># seconds</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">new_segment =</span> <span class="fu">as.numeric</span>(rest <span class="sc">&gt;</span> <span class="dv">3</span>),  </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">segment =</span> <span class="fu">cumsum</span>(new_segment)) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't want t_old to be from previous segment</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(segment) <span class="sc">|&gt;</span> </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in mutate(lagged, rest = as.numeric(time - t_old), new_segment = as.numeric(rest &gt; : object 'lagged' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>segmented</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'segmented' not found</code></pre>
</div>
</div>
<p>Now I calculate some information about each time point and segment that I’ll use in downstream analyses:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>lonlat_dist <span class="ot">&lt;-</span> <span class="fu">partial</span>(raster<span class="sc">::</span>pointDistance, <span class="at">lonlat =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>useful <span class="ot">&lt;-</span> segmented <span class="sc">|&gt;</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">seg_length =</span> <span class="fu">max</span>(time) <span class="sc">-</span> <span class="fu">min</span>(t_old),    <span class="co"># seconds</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dx =</span> <span class="fu">map2_dbl</span>(x, x_old, lonlat_dist),   <span class="co"># meters</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">dx =</span> <span class="fl">0.000621371</span> <span class="sc">*</span> dx,                  <span class="co"># miles</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dt =</span> rest <span class="sc">/</span> <span class="dv">60</span><span class="sc">^</span><span class="dv">2</span>,                       <span class="co"># hours</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">speed =</span> dx <span class="sc">/</span> dt,                        <span class="co"># mph</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pace =</span> <span class="dv">60</span> <span class="sc">*</span> dt <span class="sc">/</span> dx,                    <span class="co"># min / mile</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">elevation =</span> elevation                   <span class="co"># feet</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>elevation, <span class="sc">-</span>x, <span class="sc">-</span>x_old, <span class="sc">-</span>t_old, <span class="sc">-</span>new_segment) <span class="sc">|&gt;</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in mutate(segmented, seg_length = max(time) - min(t_old), dx = map2_dbl(x, : object 'segmented' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>useful</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'useful' not found</code></pre>
</div>
</div>
<p>We can quickly visualize instantaneous speed throughout the run:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(useful, <span class="fu">aes</span>(time, speed, <span class="at">group =</span> segment)) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Speed throughout example run"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Speed (mph)"</span>) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in ggplot(useful, aes(time, speed, group = segment)): object 'useful' not found</code></pre>
</div>
</div>
<p>We can see two short pauses present in the run at around 18:08 and 18:17.</p>
<p>We’re going to use the code above a whole bunch, so we wrap it up into a helper function. I’m not sure that <code>raster::pointDistance</code> is the best option for calculating the distance between two points, so we use a <code>dist_func</code> argument to make it easy to switch out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>get_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(gps_df, <span class="at">dist_func =</span> lonlat_dist)  {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  gps_df <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">map2</span>(longitude, latitude, c),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">x_old =</span> <span class="fu">lag</span>(x),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">t_old =</span> <span class="fu">lag</span>(time)) <span class="sc">|&gt;</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rest =</span> <span class="fu">as.numeric</span>(time <span class="sc">-</span> t_old),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">new_segment =</span> <span class="fu">as.numeric</span>(rest <span class="sc">&gt;</span> <span class="dv">3</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">segment =</span> <span class="fu">cumsum</span>(new_segment) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(segment) <span class="sc">|&gt;</span> </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">seg_length =</span> <span class="fu">max</span>(time) <span class="sc">-</span> <span class="fu">min</span>(t_old),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">dx =</span> <span class="fu">map2_dbl</span>(x, x_old, dist_func),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">dx =</span> <span class="fl">0.000621371</span> <span class="sc">*</span> dx, </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">dt =</span> rest <span class="sc">/</span> <span class="dv">60</span><span class="sc">^</span><span class="dv">2</span>,    </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">speed =</span> dx <span class="sc">/</span> dt,       </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">pace =</span> <span class="dv">60</span> <span class="sc">*</span> dt <span class="sc">/</span> dx) <span class="sc">|&gt;</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>x, <span class="sc">-</span>x_old, <span class="sc">-</span>t_old, <span class="sc">-</span>new_segment, <span class="sc">-</span>rest) <span class="sc">|&gt;</span> </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This means our initial <code>read_gpx</code> function is just two lines:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>read_gpx0 <span class="ot">&lt;-</span> <span class="cf">function</span>(fname) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  gps_df <span class="ot">&lt;-</span> gpx<span class="sc">::</span><span class="fu">read_gpx</span>(fname)<span class="sc">$</span>tracks <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>extensions, <span class="sc">-</span>segment_id)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_metrics</span>(gps_df)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use <code>profvis::profvis</code> to create an interactive visualization of how long it takes to read the example file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(profvis)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>(<span class="fu">read_gpx0</span>(fname))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>profvis: code exited with error:
Specified file does not exist</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in parse_rprof_lines(lines, expr_source): No parsing data available. Maybe your function was too fast?</code></pre>
</div>
</div>
<p>In the default view, the horizontal axis represents time and the box represents the call stack. All the boxes above <code>plotKML::readGPX</code> are functions called by <code>plotKML::readGPX</code>. Here it seems like <code>plotKML::readGPX</code> takes about 400 milliseconds to run. So about half the time is spent reading in the file, and half calculating metrics. Most of the time calculating metrics is in <code>raster::pointDistance</code>, which is fairly up the call stack - you may have to click and drag the plot to see it.</p>
</section>
<section id="gpx-reader-version-1-no-more-plotkmlgpx" class="level2">
<h2 class="anchored" data-anchor-id="gpx-reader-version-1-no-more-plotkmlgpx">GPX reader version 1: no more plotKML::GPX</h2>
<p>Then I broke my R library and couldn’t use <code>plotKML::readGPX</code> for a little while. Since GPX files are XML files, I used the <code>xml2</code> package as a replacement. <code>xml2</code> has a function <code>as_list</code> that let me treat the XML as an R list. We extract the relevant portion of the list and <code>purrr::map_dfr</code> each GPS recording into a row of a <code>tibble</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xml2)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>run_xml <span class="ot">&lt;-</span> <span class="fu">read_xml</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>run_list <span class="ot">&lt;-</span> <span class="fu">as_list</span>(run_xml)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in as_list(run_xml): object 'run_xml' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>gps_pts <span class="ot">&lt;-</span> run_list<span class="sc">$</span>gpx<span class="sc">$</span>trk<span class="sc">$</span>trkseg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'run_list' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>extract_gps_point <span class="ot">&lt;-</span> <span class="cf">function</span>(point) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> <span class="fu">attr</span>(point, <span class="st">"lon"</span>),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude =</span> <span class="fu">attr</span>(point, <span class="st">"lat"</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ele =</span> point<span class="sc">$</span>ele[[<span class="dv">1</span>]],</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> point<span class="sc">$</span>time[[<span class="dv">1</span>]]</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfr</span>(gps_pts, extract_gps_point)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in map(.x, .f, ...): object 'gps_pts' not found</code></pre>
</div>
</div>
<p>Then we wrap this in a function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>read_gpx1 <span class="ot">&lt;-</span> <span class="cf">function</span>(fname) {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  run_xml <span class="ot">&lt;-</span> <span class="fu">read_xml</span>(fname)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  run_list <span class="ot">&lt;-</span> <span class="fu">as_list</span>(run_xml)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  extract_gps_point <span class="ot">&lt;-</span> <span class="cf">function</span>(point) {</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">longitude =</span> <span class="fu">attr</span>(point, <span class="st">"lon"</span>),</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">latitude =</span> <span class="fu">attr</span>(point, <span class="st">"lat"</span>),</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">ele =</span> point<span class="sc">$</span>ele[[<span class="dv">1</span>]],</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">time =</span> point<span class="sc">$</span>time[[<span class="dv">1</span>]]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  gps_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(run_list<span class="sc">$</span>gpx<span class="sc">$</span>trk<span class="sc">$</span>trkseg, extract_gps_point)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_metrics</span>(gps_df)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next part is critical when trying to speed up code: <strong>test that the new code does the same thing as the old code</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'testthat'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    matches</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    is_null</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:readr':

    edition_get, local_edition</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:tidyr':

    matches</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span> <span class="fu">read_gpx0</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in gpx::read_gpx(fname): Specified file does not exist</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>result_1 <span class="ot">&lt;-</span> <span class="fu">read_gpx1</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># silence means everything went well</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expect_equal</span>(expected, result_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval_bare(expr, quo_get_env(quo)): object 'expected' not found</code></pre>
</div>
</div>
<p>This turned out to be too slow, so we profile and see which lines are taking the most amount of time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>(<span class="fu">read_gpx1</span>(fname))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>profvis: code exited with error:
'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in parse_rprof_lines(lines, expr_source): No parsing data available. Maybe your function was too fast?</code></pre>
</div>
</div>
<p>Here we see that we spend most of our time on the functions <code>as_list</code> and <code>tibble</code>.</p>
</section>
<section id="gpx-reader-version-2-no-more-tibble" class="level1">
<h1>GPX reader version 2: no more tibble</h1>
<p><code>tibble</code>s are somewhat heavy objects, and we can bind lists together instead of <code>tibble</code>s, so let’s try that next. We only change one line from <code>read_gpx1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>read_gpx2 <span class="ot">&lt;-</span> <span class="cf">function</span>(fname) {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  run_xml <span class="ot">&lt;-</span> <span class="fu">read_xml</span>(fname)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  run_list <span class="ot">&lt;-</span> <span class="fu">as_list</span>(run_xml)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  extract_gps_point <span class="ot">&lt;-</span> <span class="cf">function</span>(point) {</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">longitude =</span> <span class="fu">attr</span>(point, <span class="st">"lon"</span>),</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">latitude =</span> <span class="fu">attr</span>(point, <span class="st">"lat"</span>),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">ele =</span> point<span class="sc">$</span>ele[[<span class="dv">1</span>]],</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">time =</span> point<span class="sc">$</span>time[[<span class="dv">1</span>]])</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  gps_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(run_list<span class="sc">$</span>gpx<span class="sc">$</span>trk<span class="sc">$</span>trkseg, extract_gps_point)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_metrics</span>(gps_df)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>result_2 <span class="ot">&lt;-</span> <span class="fu">read_gpx2</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expect_equal</span>(expected, result_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval_bare(expr, quo_get_env(quo)): object 'expected' not found</code></pre>
</div>
</div>
<p>Our results are still as expected, which is good. We profile again to see if we’ve done any better, which we have. Now we’re at about 1.5 seconds instead of 2.5 seconds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>(<span class="fu">read_gpx2</span>(fname))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>profvis: code exited with error:
'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in parse_rprof_lines(lines, expr_source): No parsing data available. Maybe your function was too fast?</code></pre>
</div>
</div>
<p>I needed to this for about fifty files though, so this was still slow enough to be somewhat frustrating. Now <code>xml2::as_list</code> is really killing us.</p>
<section id="gpx-reader-version-3-now-with-more-xml2" class="level2">
<h2 class="anchored" data-anchor-id="gpx-reader-version-3-now-with-more-xml2">GPX reader version 3: now with more xml2</h2>
<p>Luckily, we can use <code>xml2</code> to manipulate the XML via a fast C package instead. For this next part I tried functions exported by <code>xml2</code> until they worked and occasionally read the documentation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>read_gpx_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(fname) {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the interested nodes</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  run_xml <span class="ot">&lt;-</span> <span class="fu">read_xml</span>(fname)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  trk <span class="ot">&lt;-</span> <span class="fu">xml_child</span>(run_xml, <span class="dv">2</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  trkseg <span class="ot">&lt;-</span> <span class="fu">xml_child</span>(trk, <span class="dv">2</span>)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  trkpts <span class="ot">&lt;-</span> <span class="fu">xml_children</span>(trkseg)  <span class="co"># nodeset where each node is a GPS reading</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the longitude and latitude for each node</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  latlon_list <span class="ot">&lt;-</span> <span class="fu">xml_attrs</span>(trkpts)  </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  latlon <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, latlon_list)</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the time and elevation for each node</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  ele_time_vec <span class="ot">&lt;-</span> <span class="fu">xml_text</span>(<span class="fu">xml_children</span>(trkpts))</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  ele_time <span class="ot">&lt;-</span> <span class="fu">matrix</span>(ele_time_vec, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(ele_time) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ele"</span>, <span class="st">"time"</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="fu">cbind</span>(latlon, ele_time))</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>read_gpx3 <span class="ot">&lt;-</span> <span class="cf">function</span>(fname) {</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  gps_df <span class="ot">&lt;-</span> <span class="fu">read_gpx_xml</span>(fname)</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_metrics</span>(gps_df)</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>result_3 <span class="ot">&lt;-</span> <span class="fu">read_gpx3</span>(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expect_equal</span>(expected, result_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval_bare(expr, quo_get_env(quo)): object 'expected' not found</code></pre>
</div>
</div>
<p>Again we see if there’s anywhere else we can speed things up:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>(<span class="fu">read_gpx3</span>(fname))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>profvis: code exited with error:
'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in parse_rprof_lines(lines, expr_source): No parsing data available. Maybe your function was too fast?</code></pre>
</div>
</div>
<p>We’re way faster, taking less than half a second! Now the most time is spent on <code>raster::pointDistance</code>, which we call a ton of times. What does <code>pointDistance</code> do? It takes two pairs <code>(lat1, lon1)</code> and <code>(lat2, lon2)</code> the distance between them<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
</section>
<section id="gpx-reader-version-4-drop-into-rcpp" class="level2">
<h2 class="anchored" data-anchor-id="gpx-reader-version-4-drop-into-rcpp">GPX reader version 4: drop into Rcpp</h2>
<p>Next I Googled how to perform this calculation myself and found <a href="http://www.movable-type.co.uk/scripts/latlong.html#ellipsoid">this</a> and <a href="https://www.r-bloggers.com/great-circle-distance-calculations-in-r/">this</a>. The <code>Rcpp</code> implementation looks like:</p>
<div class="cell">
<pre class="rcpp cell-code"><code>#include &lt;Rcpp.h&gt;

using namespace Rcpp;

// [[Rcpp::export]]
double haversine_dist(const NumericVector p1, const NumericVector p2) {
  
  double lat1 = p1[0] * M_PI / 180;
  double lon1 = p1[1] * M_PI / 180;
  double lat2 = p2[0] * M_PI / 180;
  double lon2 = p2[1] * M_PI / 180;
  
  double d_lat = lat2 - lat1;
  double d_lon = lon2 - lon1;
  
  double a = pow(sin(d_lat / 2.0), 2) + 
    cos(lat1) * cos(lat2) * pow(sin(d_lon / 2.0), 2);
  double c = 2 * asin(std::min(1.0, sqrt(a)));
  
  return 6378137 * c; // 6378137 is the radius of the earth in meters
}</code></pre>
</div>
<p>The haversine distance is fast to calculate at the cost of some small error, which we can see below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>dist_expected <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">pointDistance</span>(p1, p2, <span class="at">lonlat =</span> <span class="cn">TRUE</span>)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>dist_result <span class="ot">&lt;-</span> <span class="fu">haversine_dist</span>(p1, p2)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>dist_result <span class="sc">-</span> dist_expected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 525.9688</code></pre>
</div>
</div>
<p>It turns out that “small error” on the geological scale is big error on the neighborhood run scale. Put all together, the C++ version looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>read_gpx4 <span class="ot">&lt;-</span> <span class="cf">function</span>(fname) {</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  gps_df <span class="ot">&lt;-</span> <span class="fu">read_gpx_xml</span>(fname)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_metrics</span>(gps_df, <span class="at">dist_func =</span> haversine_dist)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We profile one more time:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>(<span class="fu">read_gpx4</span>(fname))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>profvis: code exited with error:
'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in parse_rprof_lines(lines, expr_source): No parsing data available. Maybe your function was too fast?</code></pre>
</div>
</div>
<p>Now it takes only about 0.1 seconds, but the result isn’t accurate enough anymore. I wasn’t in the mood to implement a more precise great circle distance calculation, but hopefully this illustrates the general principle of dropping into <code>Rcpp</code> and also why it’s important to test when profiling.</p>
</section>
<section id="comparing-the-various-gpx-readers" class="level2">
<h2 class="anchored" data-anchor-id="comparing-the-various-gpx-readers">Comparing the various GPX readers</h2>
<p>Now we can compare how long each version takes using the <code>bench</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bench)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mark</span>(</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_gpx0</span>(fname),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_gpx1</span>(fname),</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_gpx2</span>(fname),</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_gpx3</span>(fname),</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_gpx4</span>(fname),</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="dv">5</span>,   <span class="co"># how many times to run everything. 5 is very low.</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">relative =</span> <span class="cn">TRUE</span>,</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">check =</span> <span class="cn">FALSE</span>     <span class="co"># since readgpx4 isn't right, will error without this</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in gpx::read_gpx(fname): Specified file does not exist</code></pre>
</div>
</div>
<p>Here timings are relative. We see that <code>read_gpx4</code> is about ten times faster than <code>read_gpx1</code> and two times faster than <code>read_gpx0</code>.</p>
</section>
<section id="embarrassing-parallelization-with-furrr" class="level2">
<h2 class="anchored" data-anchor-id="embarrassing-parallelization-with-furrr">Embarrassing parallelization with <code>furrr</code></h2>
<p>In the end, I needed to do this for about fifty files. Since we can process each file independently of the other files, this operation is <em>embarrassingly parallel</em>. I actually wanted to use this data, so I didn’t use the C++ haversine distance function. We can write with a single <code>map</code> call to process all the files at once:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>run_files_subset <span class="ot">&lt;-</span> run_files[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfr</span>(run_files_subset, read_gpx3, <span class="at">.id =</span> <span class="st">"run"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
</div>
<p>Which means we can also write this as a parallelized <code>map</code> call with <code>furrr</code> like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: future</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multiprocess)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Strategy 'multiprocess' is deprecated in future (&gt;= 1.20.0). Instead,
explicitly specify either 'multisession' or 'multicore'. In the current R
session, 'multiprocess' equals 'multicore'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">future_map_dfr</span>(run_files_subset, read_gpx3, <span class="at">.id =</span> <span class="st">"run"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
</div>
<p>Note that other than loading <code>furrr</code> and calling <code>plan(multiprocess)</code> all we’ve had to do to get parallelism is to call <code>furrr::future_map_dfr</code>, which has exactly the same API as <code>purrr::map_dfr</code>. My computer has two cores, meaning there’s a maximum possible speedup of two, and we achieve nearly that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mark</span>( </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(run_files_subset, read_gpx3, <span class="at">.id =</span> <span class="st">"run"</span>),</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">future_map_dfr</span>(run_files_subset, read_gpx3, <span class="at">.id =</span> <span class="st">"run"</span>),</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="dv">5</span>,</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">relative =</span> <span class="cn">TRUE</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 'NA' does not exist in current working directory ('/dabox/hayes/quarto-blog/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr').</code></pre>
</div>
</div>
</section>
<section id="wrap-up" class="level2">
<h2 class="anchored" data-anchor-id="wrap-up">Wrap Up</h2>
<p>This was a low stakes exercise in speeding up R code. By the time I’d written all of these it would have been several hundred times faster to use <code>read_gpx0</code> and just save the results to a <code>.rds</code> file. Still, it was fun to work through the profiling workflow and I look forward to enterprising strangers on the internet pointing out places where things can get faster still.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>It took me a two months to realize this, mostly because I didn’t plot enough of the data. If you’re curous how Strava detects paused movement, you can read more <a href="https://medium.com/strava-engineering/improving-auto-pause-for-everyone-13f253c66f9e">here</a>. It seems to involve more if-statements than fun models.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>We can’t calculate the distance using the L2 norm because longitude and latitude are spherical coordinates, not Euclidean coordinates.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{hayes2018,
  author = {Alex Hayes},
  title = {Speeding up {GPX} Ingest: Profiling, {Rcpp} and Furrr},
  date = {2018-06-15},
  url = {https://www.alexpghayes.com/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-hayes2018" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Alex Hayes. 2018. <span>“Speeding up GPX Ingest: Profiling, Rcpp and
Furrr.”</span> June 15, 2018. <a href="https://www.alexpghayes.com/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr">https://www.alexpghayes.com/blog/2018-06-15_speeding-up-gpx-ingest-profiling-rcpp-and-furrr</a>.
</div></div></section></div></main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>