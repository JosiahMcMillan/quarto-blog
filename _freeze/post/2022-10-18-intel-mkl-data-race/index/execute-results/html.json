{
  "hash": "e90a420f355c60bef12623f56f03d898",
  "result": {
    "markdown": "---\ntitle: \"intel mkl drunk driving\"\nsubtitle: |\n  sweet jesus, no more data race please\ndate: \"2022-10-18\"\ncategories: [notes to self, fuck]\ndraft: true\n---\n\n\n## Motivation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(27)\n\nX <- matrix(rnorm(500), 50, 10)\n\ns <- svd(X)\n\nonce <- function() {\n  Xhat <- s$u %*% diag(s$d) %*% t(s$v)  # has to a big enough matrix multiply\n  norm(Xhat)\n}\n\nonce()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 30057.02\n```\n:::\n\n```{.r .cell-code}\nonce()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 31288.76\n```\n:::\n\n```{.r .cell-code}\nonce()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 28439.83\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nutils::sessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.2.1 (2022-06-23)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.1 LTS\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib/x86_64-linux-gnu/libmkl_rt.so\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] digest_0.6.29          lifecycle_1.0.3.9000   jsonlite_1.8.0        \n [4] magrittr_2.0.3.9000    evaluate_0.16.1        rlang_1.0.6           \n [7] stringi_1.7.8          cli_3.4.1              rstudioapi_0.14.0-9000\n[10] vctrs_0.4.1.9000       rmarkdown_2.16.1       tools_4.2.1           \n[13] stringr_1.4.1.9000     glue_1.6.2.9000        htmlwidgets_1.5.4     \n[16] xfun_0.32              yaml_2.3.5             fastmap_1.1.0.9000    \n[19] compiler_4.2.1         htmltools_0.5.3.9000   knitr_1.40            \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nSys.setenv(MKL_NUM_THREADS = \"1\")\nSys.setenv(MKL_INTERFACE_LAYER = \"GNU,LP64\")\nSys.setenv(MKL_THREADING_LAYER = \"GNU\")\nSys.getenv(\"MKL_THREADING_LAYER\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"GNU\"\n```\n:::\n\n```{.r .cell-code}\nSys.getenv(\"MKL_INTERFACE_LAYER\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"GNU,LP64\"\n```\n:::\n\n```{.r .cell-code}\nSys.getenv(\"MKL_NUM_THREADS\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"1\"\n```\n:::\n\n```{.r .cell-code}\nonce()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 55602.3\n```\n:::\n\n```{.r .cell-code}\nonce()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 32482.82\n```\n:::\n\n```{.r .cell-code}\nonce()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 26024.84\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# one computers with multiple cores, Intel MKL can induce data races\n# during sufficiently large matrix multiples depending on the threading\n# model\ncan_induce_data_race <- function() {\n  X <- matrix(1:500 / 500, 50, 10)\n  Y <- matrix(1:1000 / 1000, 10, 100)\n  \n  norm(X %*% Y)\n}\n\nSys.getenv(\"MKL_THREADING_LAYER\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"GNU\"\n```\n:::\n\n```{.r .cell-code}\ncan_induce_data_race()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2997.423\n```\n:::\n\n```{.r .cell-code}\ncan_induce_data_race()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2997.423\n```\n:::\n\n```{.r .cell-code}\ncan_induce_data_race()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2758.585\n```\n:::\n\n```{.r .cell-code}\ncallr::r(can_induce_data_race)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 249.7852\n```\n:::\n\n```{.r .cell-code}\ncallr::r(can_induce_data_race, env = c(MKL_THREADING_LAYER = \"GNU\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 249.7852\n```\n:::\n\n```{.r .cell-code}\nSys.setenv(MKL_THREADING_LAYER = \"GNU\")\nSys.getenv(\"MKL_THREADING_LAYER\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"GNU\"\n```\n:::\n\n```{.r .cell-code}\ncallr::r(can_induce_data_race)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 249.7852\n```\n:::\n\n```{.r .cell-code}\ncallr::r(can_induce_data_race, env = c(MKL_THREADING_LAYER = \"GNU\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 249.7852\n```\n:::\n:::\n\n\n\n\nhttps://raw.githack.com/uo-ec607/lectures/master/14-gce-i/14-gce-i.html#Install_the_Intel_Math_Kernel_Library_(MKL)_or_OpenBLASLAPACK\n\n\nhttps://phillipalday.com/blog/2013/05/31/Speed-up-R-(on-Linux)/\n\nhttps://www.enchufa2.es/archives/switch-blas-lapack-without-leaving-your-r-session.html\n\nhttps://github.com/eddelbuettel/mkl4deb\n\nhttps://cran.r-project.org/web/packages/RhpcBLASctl/index.html\n\nhttps://twitter.com/dan_p_simpson/status/1571705560634105857/",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}